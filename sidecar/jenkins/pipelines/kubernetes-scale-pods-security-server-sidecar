pipeline {
    agent any
    parameters {
        string(description: "Number of pod replicas", name: "NUMBER_REPLICAS", defaultValue: "${params?.NUMBER_REPLICAS}")
        string(description: "Token code for MFA login", name: "TOKEN_CODE", defaultValue: "${params?.TOKEN_CODE}")
    }
    stages {
        stage('Scale replicas') {
            steps {
                sh '''
                    unset AWS_SESSION_TOKEN
                    unset AWS_SECRET_ACCESS_KEY
                    unset AWS_ACCESS_KEY_ID

                    CREDENTIALS=`aws sts get-session-token --serial-number arn:aws:iam::942718799483:mfa/alberto.fernandez --token-code $TOKEN_CODE`

                    export AWS_ACCESS_KEY_ID=`echo $CREDENTIALS | jq -r '.Credentials.AccessKeyId'`
                    export AWS_SECRET_ACCESS_KEY=`echo $CREDENTIALS | jq -r '.Credentials.SecretAccessKey'`
                    export AWS_SESSION_TOKEN=`echo $CREDENTIALS | jq -r '.Credentials.SessionToken'`
                    
                    kubectl scale --replicas=${NUMBER_REPLICAS} deployment.v1.apps/security-server-sidecar
                '''
            }
        }
    }
}