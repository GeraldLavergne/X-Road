pipeline {
    agent { label 'dev-test' }
    parameters {
        string(description: "Instance id", name: "INSTANDE_ID", defaultValue: "${params?.INSTANDE_ID}")
        string(description: "User", name: "USER", defaultValue: "${params?.USER}")
        string(description: "Public key", name: "PUBLIC_KEY", defaultValue: "${params?.PUBLIC_KEY}")
        string(description: "Region code", name: "REGION_CODE", defaultValue: "${params?.REGION_CODE}")
    }
    stages {
      stage('Add public key') {
            steps {
                 withCredentials([usernamePassword(credentialsId: 'AWS', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh 'aws ec2-instance-connect send-ssh-public-key \
                       --instance-id ${INSTANDE_ID} \
                       --instance-os-user ${USER} \
                       --ssh-public-key file://home/alberto/id_rsa.pub \
                       --availability-zone ${REGION_CODE}'
                }
            }
        }
    }
}
